// Backbone with Benefits 0.1.0 (https://github.com/javan/backbone-with-benefits)
// Copyright (c) 2014 Javan Makhmali <javan@javan.us> (http://javan.us)
// MIT license (http://opensource.org/licenses/MIT)
(function(){var a,b,c,d,e,f,g,h;"undefined"!=typeof exports&&null!==exports&&!function(){return this._=require("underscore"),exports.Backbone=this.Backbone=require("backbone")}(),Backbone.Benefits={db:{},register:function(a){this.db=a}},_.extend(Backbone.Model,{hasMany:function(a,f){var h,i,j,k,l,m,n,o;return o=null!=f?f:{},k=o.foreignKey,h=o.as,n=o.through,j=o.conditions,l=o.modelName,i=o.collectionName,m=o.source,this.prototype[b(a)]=function(b){var f,o,p,q;if(null==i&&(i=null!=l?l:a),null==j&&(j={}),p=e(this.constructor),f=c(i),null!=n)null==m&&(m=g(i)),o=_.isEmpty(j)?_(this[n]().toArray()).invoke(m):_(this[n]().where(j)).invoke(m),null==f&&(f=null!=(q=o[0])?q.collection:void 0);else{switch(!1){case!k:j[k]=this.id;break;case!h:j[""+h+"_type"]=p,j[""+h+"_id"]=this.id;break;default:k=d(p),j[k]=this.id}o=f.where(j)}return new f.constructor(o,b)}},belongsTo:function(a,e){var f,g,h,i,j;return j=null!=e?e:{},i=j.polymorphic,g=j.foreignKey,h=j.modelName,f=j.collectionName,this.prototype[b(a)]=function(){switch(!1){case!i:f=this.get(""+a+"_type"),g=""+a+"_id";break;case!h:null==f&&(f=h),null==g&&(g=d(a));break;default:null==f&&(f=a),null==g&&(g=d(f))}return null!=f&&null!=g?c(f).get(this.get(g)):void 0}}}),c=function(a){var c,d,e,g,h;for(e=[a,f(a),b(f(a))],g=0,h=e.length;h>g;g++)if(d=e[g],c=Backbone.Benefits.db[d])return c},e=function(a){var b,c,d;return null!=(b=null!=(c=a.modelName)?c:a.name)?b:null!=(d=a.toString().match(/function\s*(\w+)/))?d[1]:void 0},d=function(a){return h(g(a))+"_id"},h=function(a){return a.replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},a=function(a){return a.charAt(0).toUpperCase()+a.substring(1)},b=function(a){return a.charAt(0).toLowerCase()+a.substring(1)},f=function(a){return a.replace(/([^s])$/,"$1s")},g=function(a){return a.replace(/s$/,"")}}).call(this);